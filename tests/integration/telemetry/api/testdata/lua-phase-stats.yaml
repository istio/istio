apiVersion: extensions.istio.io/v1alpha1
kind: ExtensionFilter
metadata:
  name: {{ .ExtensionFilterName }}-stats
spec:
  phase: STATS
  selector:
    matchLabels:
      app: {{ .TargetAppName }}
  lua:
    inlineCode: |
      function envoy_on_request(request_handle)
        -- Third phase: append to existing value
        local existing = request_handle:headers():get("x-phase-order")
        if existing then
          request_handle:headers():replace("x-phase-order", existing .. "3")
        else
          request_handle:headers():add("x-phase-order", "3")
        end
      end

      function envoy_on_response(response_handle)
        -- Echo the request header value to response so we can verify it
        local order = response_handle:headers():get("x-phase-order")
        if order then
          response_handle:headers():add("x-phase-result", order)
        end
      end
