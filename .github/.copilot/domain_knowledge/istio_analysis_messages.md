# Istio Analysis Messages

This document explains Istio's Analysis messages: what they are, how users can access them, and how to add new analyzers to the system.

## Introduction

Istio Analysis messages are diagnostic outputs produced by static and runtime analyzers that inspect Istio configuration and environment. They help users identify misconfigurations, potential issues, and best practice violations before they impact the mesh.

## Conceptual Overview

- **Analysis messages** are generated by analyzers that scan Istio resources (YAML manifests, live cluster state, etc.).
- Each message includes a code, severity, resource reference, and a human-readable description.
- Analysis can be run as part of `istioctl analyze`, during installation, or via the Istio Operator.
- Analyzers are modular and can be extended by contributors.

## Implementation Architecture

1. **Analyzer Registration**: Analyzers are registered in the analysis framework.
2. **Input Gathering**: The framework collects resources from files, clusters, or both.
3. **Analysis Execution**: Each analyzer inspects the resources and emits messages.
4. **Message Aggregation**: Messages are collected, deduplicated, and presented to the user.

### Key Relationships
- Analyzers implement the `analysis.Analyzer` interface.
- The analysis framework orchestrates analyzer execution and message collection.
- Messages are instances of `diag.Message`.

## Code Implementation

### Accessing Analysis Messages

Users can access analysis messages in several ways:

#### 1. Via istioctl

```bash
istioctl analyze -A
```
- Analyzes all namespaces in the current cluster context and prints messages to stdout.

#### 2. During Installation

- `istioctl install` and `istioctl upgrade` run analysis by default and display warnings before applying changes.

#### 3. In CI/CD

- Integrate `istioctl analyze` into pipelines to catch issues before deployment.

### Adding a New Analyzer

1. **Implement the Analyzer Interface**

```go
// From istioctl/pkg/analyze/analysis.go
// Analyzer interface
type Analyzer interface {
    Metadata() Metadata
    Analyze(Context)
}
```

2. **Define Metadata**

```go
// From istioctl/pkg/analyze/metadata.go
type Metadata struct {
    Name string
    Description string
    Inputs collection.Names
}
```

3. **Emit Messages**

```go
// From istioctl/pkg/analyze/context.go
ctx.Report(collection, diag.NewMessage(...))
```

4. **Register the Analyzer**

- Add your analyzer to the list in `istioctl/pkg/analyze/all/all.go`.

## Key Interfaces/Models

- `analysis.Analyzer`: Analyzer contract (`istioctl/pkg/analyze/analysis.go`)
- `diag.Message`: Analysis message structure (`istio.io/istio/pkg/config/analysis/diag/message.go`)
- `Context`: Used to emit messages (`istioctl/pkg/analyze/context.go`)

## Example Use Cases

- Detecting missing gateways referenced by VirtualServices
- Warning about deprecated API usage
- Identifying conflicting DestinationRules

## Best Practices

- Make messages actionable and clear; include resource references.
- Use appropriate severity (Error, Warning, Info).
- Avoid false positives by checking for all required context.
- Add tests for new analyzers in `istioctl/pkg/analyze/testdata/`.

## Related Components

- [istioctl analyze](istioctl_commands.md): CLI for running analyzers
